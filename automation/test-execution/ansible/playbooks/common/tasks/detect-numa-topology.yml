---
# Detect NUMA Topology on DUT
# Auto-discovers NUMA nodes and allocates cores for vLLM/guidellm
# Uses custom Jinja2 filters instead of awk/shell scripts for better maintainability

- name: Get lscpu output
  ansible.builtin.command:
    cmd: lscpu -e=CPU,NODE,CORE -n
  register: lscpu_output
  changed_when: false
  failed_when: false

- name: Parse lscpu output (fallback for older lscpu)
  ansible.builtin.command:
    cmd: lscpu -e=CPU,NODE,CORE
  register: lscpu_output_with_header
  when: lscpu_output.rc != 0
  changed_when: false

- name: Set lscpu data
  ansible.builtin.set_fact:
    lscpu_data: "{{ lscpu_output.stdout if lscpu_output.rc == 0 else lscpu_output_with_header.stdout_lines[1:] | join('\n') }}"

- name: Extract NUMA nodes using custom filter
  ansible.builtin.set_fact:
    numa_nodes: "{{ lscpu_data | extract_numa_nodes }}"

- name: Count NUMA nodes
  ansible.builtin.set_fact:
    numa_node_count: "{{ numa_nodes | length }}"

- name: Display detected NUMA topology
  ansible.builtin.debug:
    msg:
      - "Detected NUMA Topology:"
      - "  NUMA nodes: {{ numa_nodes }}"
      - "  Node count: {{ numa_node_count }}"

- name: Validate minimum NUMA nodes
  ansible.builtin.assert:
    that:
      - numa_node_count | int >= 1
    fail_msg: "Failed to detect NUMA topology"
    success_msg: "✓ NUMA topology detected"

- name: Determine node allocation strategy
  ansible.builtin.set_fact:
    # For multi-node systems: housekeeping=0, guidellm=1, vllm=last
    # For single-node: all on node 0
    housekeeping_node: 0
    guidellm_node: "{{ 1 if numa_node_count | int >= 2 else 0 }}"
    vllm_node: "{{ numa_nodes[-1] if numa_node_count | int >= 3 else (numa_nodes[-1] if numa_node_count | int >= 2 else 0) }}"

- name: Display node allocation
  ansible.builtin.debug:
    msg:
      - "Node Allocation Strategy:"
      - "  Housekeeping: node {{ housekeeping_node }}"
      - "  GuideLLM: node {{ guidellm_node }}"
      - "  vLLM: node {{ vllm_node }}"

# Extract CPUs using custom Jinja2 filters (replaces awk scripts)
- name: Extract all CPUs for housekeeping node
  ansible.builtin.set_fact:
    house_cpus_list: "{{ lscpu_data | extract_all_cpus(housekeeping_node) }}"

- name: Extract primary CPUs for guidellm node
  ansible.builtin.set_fact:
    guide_cpus_list: "{{ lscpu_data | extract_primary_cpus(guidellm_node) }}"

- name: Extract primary CPUs for vLLM node
  ansible.builtin.set_fact:
    vllm_cpus_list: "{{ lscpu_data | extract_primary_cpus(vllm_node) }}"

# Convert to ranges using custom filter (replaces awk range conversion)
- name: Convert CPU lists to ranges
  ansible.builtin.set_fact:
    house_cpus_range: "{{ house_cpus_list | cpu_list_to_range }}"
    guide_cpus_range: "{{ guide_cpus_list | cpu_list_to_range }}"
    vllm_cpus_range: "{{ vllm_cpus_list | cpu_list_to_range }}"

- name: Set NUMA topology facts
  ansible.builtin.set_fact:
    numa_topology:
      nodes: "{{ numa_nodes }}"
      node_count: "{{ numa_node_count }}"
      housekeeping:
        node: "{{ housekeeping_node }}"
        cpus: "{{ house_cpus_range }}"
      guidellm:
        node: "{{ guidellm_node }}"
        cpus: "{{ guide_cpus_range }}"
      vllm:
        node: "{{ vllm_node }}"
        cpus: "{{ vllm_cpus_range }}"
        cpus_list: "{{ vllm_cpus_list }}"

- name: Display complete NUMA topology
  ansible.builtin.debug:
    msg:
      - "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
      - "NUMA Topology Detection Complete"
      - "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
      - "Housekeeping: node {{ numa_topology.housekeeping.node }}, CPUs {{ numa_topology.housekeeping.cpus }}"
      - "GuideLLM: node {{ numa_topology.guidellm.node }}, CPUs {{ numa_topology.guidellm.cpus }}"
      - "vLLM: node {{ numa_topology.vllm.node }}, CPUs {{ numa_topology.vllm.cpus }}"
      - "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
