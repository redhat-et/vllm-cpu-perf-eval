---
# Common Log Collection Playbook
# Collects logs from DUT and load generator
# Can be imported by other playbooks or run standalone

- name: "Collect Logs - Setup"
  hosts: localhost
  gather_facts: false
  vars:
    collection_id: "{{ lookup('pipe', 'date +%Y%m%d-%H%M%S') }}"

  tasks:
    - name: Set collection_id fact for all hosts
      ansible.builtin.set_fact:
        collection_id: "{{ collection_id }}"
      delegate_to: "{{ item }}"
      delegate_facts: true
      loop: "{{ groups['all'] }}"

    - name: Display log collection info
      ansible.builtin.debug:
        msg:
          - "Log Collection ID: {{ collection_id }}"
          - "DUT: {{ groups['dut'][0] }}"
          - "Load Generator: {{ groups['load_generator'][0] }}"

# ==============================================================================
# Collect vLLM Server Logs from DUT
# ==============================================================================

- name: "Collect vLLM Server Logs"
  hosts: dut
  become: true
  vars:
    container_name: "{{ vllm_container_name | default('vllm-embedding-server') }}"

  tasks:
    - name: Check if vLLM container exists
      ansible.builtin.shell:
        cmd: "podman ps -a --filter name={{ container_name }} --format '{{'{{'}}.Names{{'}}'}}'"
      register: container_check
      changed_when: false
      when: container_runtime.engine == 'podman'

    - name: Get vLLM container logs (if running)
      ansible.builtin.command:
        cmd: "podman logs {{ container_name }}"
      register: vllm_logs
      changed_when: false
      when:
        - container_runtime.engine == 'podman'
        - container_check.stdout | length > 0

    - name: Save vLLM logs to file
      ansible.builtin.copy:
        content: "{{ vllm_logs.stdout }}"
        dest: "{{ log_dir }}/vllm-server-{{ collection_id }}.log"
      when: vllm_logs is defined and vllm_logs.stdout is defined

    - name: Get journald logs for vLLM
      ansible.builtin.command:
        cmd: "journalctl -t vllm-embedding --since '1 hour ago' --no-pager"
      register: journald_logs
      changed_when: false
      ignore_errors: true

    - name: Save journald logs to file
      ansible.builtin.copy:
        content: "{{ journald_logs.stdout }}"
        dest: "{{ log_dir }}/vllm-journald-{{ collection_id }}.log"
      when: journald_logs is defined and journald_logs.stdout is defined

    - name: Collect system metrics snapshot
      ansible.builtin.shell: |
        echo "=== CPU Info ===" > {{ log_dir }}/system-metrics-{{ collection_id }}.log
        lscpu >> {{ log_dir }}/system-metrics-{{ collection_id }}.log
        echo "" >> {{ log_dir }}/system-metrics-{{ collection_id }}.log
        echo "=== Memory Usage ===" >> {{ log_dir }}/system-metrics-{{ collection_id }}.log
        free -h >> {{ log_dir }}/system-metrics-{{ collection_id }}.log
        echo "" >> {{ log_dir }}/system-metrics-{{ collection_id }}.log
        echo "=== Container Stats ===" >> {{ log_dir }}/system-metrics-{{ collection_id }}.log
        podman stats --no-stream {{ container_name }} >> {{ log_dir }}/system-metrics-{{ collection_id }}.log 2>&1 || true
      args:
        executable: /bin/bash
      changed_when: false

    - name: List collected log files
      ansible.builtin.find:
        paths: "{{ log_dir }}"
        patterns: "*{{ collection_id }}*"
      register: collected_logs

    - name: Display collected logs
      ansible.builtin.debug:
        msg: "Collected {{ collected_logs.files | length }} log files"

    - name: Fetch logs to controller
      ansible.builtin.fetch:
        src: "{{ item.path }}"
        dest: "{{ playbook_dir }}/../../../results/logs/{{ inventory_hostname }}/"
        flat: false
      loop: "{{ collected_logs.files }}"
      loop_control:
        label: "{{ item.path | basename }}"

# ==============================================================================
# Collect Test Results from Load Generator
# ==============================================================================

- name: "Collect Test Results"
  hosts: load_generator
  gather_facts: false

  tasks:
    - name: Check if results directory exists
      ansible.builtin.stat:
        path: "{{ bench_config.results_dir }}"
      register: results_dir_stat

    - name: Fetch test results to controller
      ansible.posix.synchronize:
        src: "{{ bench_config.results_dir }}/"
        dest: "{{ playbook_dir }}/../../../results/benchmark-results/"
        mode: pull
        recursive: true
      when: results_dir_stat.stat.exists

    - name: Display results collection status
      ansible.builtin.debug:
        msg: "{{ 'Results fetched from ' + bench_config.results_dir if results_dir_stat.stat.exists else 'No results directory found' }}"

# ==============================================================================
# Summary
# ==============================================================================

- name: "Log Collection Summary"
  hosts: localhost
  gather_facts: false
  vars:
    collection_id: "{{ hostvars['localhost']['collection_id'] | default(lookup('pipe', 'date +%Y%m%d-%H%M%S')) }}"

  tasks:
    - name: Display collection summary
      ansible.builtin.debug:
        msg:
          - "Log Collection Complete!"
          - "Collection ID: {{ collection_id }}"
          - "Logs saved to: {{ playbook_dir }}/../../../results/logs/"
          - "Results saved to: {{ playbook_dir }}/../../../results/benchmark-results/"
          - ""
          - "View logs:"
          - "  DUT logs: cat results/logs/{{ groups['dut'][0] }}/*.log"
          - "  Results: ls -lh results/benchmark-results/"
