---
# Core Count Sweep Playbook for Embedding Tests
# Tests vLLM performance with varying CPU core allocations
# Deploys containerized vLLM with different core counts up to NUMA node boundary

- name: "Embedding Core Count Sweep - Setup"
  hosts: localhost
  gather_facts: false
  vars:
    test_run_id: "{{ lookup('pipe', 'date +%Y%m%d-%H%M%S') }}"

  tasks:
    - name: Display core sweep test information
      ansible.builtin.debug:
        msg:
          - "Core Count Sweep Test Run ID: {{ test_run_id }}"
          - "Testing core counts: {{ core_counts }}"
          - "DUT Host: {{ groups['dut'][0] }}"
          - "Load Generator Host: {{ groups['load_generator'][0] }}"

    - name: Set vLLM mode
      ansible.builtin.set_fact:
        vllm_mode: "{{ vllm_endpoint.mode | default('managed') }}"

    - name: Display vLLM configuration
      ansible.builtin.debug:
        msg:
          - "vLLM Mode: {{ vllm_mode }}"
          - "{{ 'External Endpoint: ' + vllm_endpoint.external.url if vllm_mode == 'external' else 'Managed on DUT: ' + groups['dut'][0] }}"

    - name: Warn about external mode with core sweep
      ansible.builtin.debug:
        msg:
          - "⚠️  WARNING: External mode does not support core configuration."
          - "All tests will run against the same external endpoint regardless of core_counts."
      when: vllm_mode == 'external'

# ==============================================================================
# EXTERNAL MODE: Configure External Endpoint (Once)
# ==============================================================================

- name: "Configure External Endpoint"
  hosts: load_generator
  gather_facts: false

  tasks:
    - block:
        - name: Validate external endpoint URL
          ansible.builtin.assert:
            that:
              - vllm_endpoint.external.url is defined
              - vllm_endpoint.external.url is not none
              - vllm_endpoint.external.url | length > 0
            fail_msg: "External endpoint URL is required when mode=external"

        - name: Parse external endpoint URL
          ansible.builtin.set_fact:
            external_endpoint_parsed: "{{ vllm_endpoint.external.url | urlsplit }}"

        - name: Override bench_config for external endpoint
          ansible.builtin.set_fact:
            bench_config: "{{ bench_config | combine({'vllm_host': external_endpoint_parsed.hostname, 'vllm_port': external_endpoint_parsed.port | default(8000) | int}) }}"

        - name: Setup API key if enabled
          ansible.builtin.include_tasks:
            file: ../common/tasks/setup-vllm-api-key.yml
          when: vllm_endpoint.external.api_key.enabled | default(false) | bool

        - name: Display external endpoint configuration
          ansible.builtin.debug:
            msg:
              - "External vLLM Endpoint: {{ vllm_endpoint.external.url }}"
              - "Parsed Host: {{ bench_config.vllm_host }}"
              - "Parsed Port: {{ bench_config.vllm_port }}"
              - "{{ 'API Key: Enabled' if vllm_api_key is defined else 'API Key: Not configured' }}"

      when: hostvars['localhost']['vllm_mode'] == 'external'
- name: "Health Check - External Endpoint"
  ansible.builtin.import_playbook: ../common/health-check.yml

# ==============================================================================
# MAIN LOOP: Iterate over core counts
# ==============================================================================

- name: "Core Count Sweep - Run Tests for Each Core Configuration"
  hosts: localhost
  gather_facts: false
  vars:
    # Define core counts to test (can be overridden)
    # Default: 8, 16, 32, 64 (up to 1 NUMA node on typical systems)
    core_counts: "{{ test_core_counts | default([8, 16, 32, 64]) }}"
    model_name: "{{ test_model | default('ibm-granite/granite-embedding-278m-multilingual') }}"
    test_scenario: "{{ scenario | default('baseline') }}"

  tasks:
    - block:
        - name: "Run test sequence for each core count"
          ansible.builtin.include_tasks:
            file: tasks/core-iteration.yml
          loop: "{{ core_counts }}"
          loop_control:
            loop_var: current_core_count
            label: "Core count: {{ current_core_count }}"

      when: hostvars['localhost']['vllm_mode'] == 'external'
# ==============================================================================
# FINAL: Collect All Results
# ==============================================================================

- name: "Core Sweep - Collect and Summarize Results"
  hosts: load_generator
  gather_facts: false

  tasks:
    - name: Fetch all core sweep results
      ansible.builtin.fetch:
        src: "{{ bench_config.results_dir }}/core-sweep/"
        dest: "{{ playbook_dir }}/../../results/embedding-models/core-sweep-{{ test_run_id }}/"
        flat: false

    - name: Display results location
      ansible.builtin.debug:
        msg:
          - "Core sweep tests completed!"
          - "Results: {{ playbook_dir }}/../../results/embedding-models/core-sweep-{{ test_run_id }}/"
          - "Analyze results to find optimal core count for performance"
