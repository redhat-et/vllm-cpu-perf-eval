---
# Single iteration for a specific core count
# Included by run-embedding-core-sweep.yml

# ==============================================================================
# STEP 1: Deploy vLLM with specific core count on DUT
# ==============================================================================

- name: "Deploy vLLM with {{ current_core_count }} cores"
  hosts: dut
  become: true
  vars:
    cores_to_use: "{{ hostvars['localhost']['current_core_count'] }}"
    model: "{{ hostvars['localhost']['model_name'] }}"

  tasks:
    - name: Calculate CPU set for core allocation
      ansible.builtin.set_fact:
        # Allocate cores 0 to (cores_to_use - 1)
        cpu_set: "0-{{ cores_to_use - 1 }}"
        # Set OMP threads to match core count
        omp_threads: "{{ cores_to_use }}"

    - name: Stop any existing vLLM container
      containers.podman.podman_container:
        name: vllm-embedding-server
        state: absent
      ignore_errors: true

    - name: Start vLLM server with {{ cores_to_use }} cores
      containers.podman.podman_container:
        name: vllm-embedding-server
        image: "{{ vllm_server.container_image }}"
        state: started
        restart_policy: "no"
        detach: true
        network: host
        # CPU pinning
        cpuset_cpus: "{{ cpu_set }}"
        volumes:
          - "{{ model_cache_dir }}:/root/.cache/huggingface:rw"
          - "{{ log_dir }}:/var/log/vllm:rw"
        env:
          VLLM_CPU_KVCACHE_SPACE: "{{ vllm_env.VLLM_CPU_KVCACHE_SPACE }}"
          OMP_NUM_THREADS: "{{ omp_threads }}"
          VLLM_CPU_OMP_THREADS_BIND: "{{ cpu_set }}"
        command: >
          --model {{ model }}
          --host {{ vllm_server.host }}
          --port {{ vllm_server.port }}
          --dtype bfloat16
          --max-model-len 512
        log_driver: journald
        log_opt:
          tag: "vllm-embedding-{{ cores_to_use }}cores"
      register: vllm_container

    - name: Display vLLM deployment info
      ansible.builtin.debug:
        msg:
          - "vLLM deployed with {{ cores_to_use }} cores"
          - "CPU Set: {{ cpu_set }}"
          - "OMP Threads: {{ omp_threads }}"
          - "Container ID: {{ vllm_container.container.Id[:12] }}"

    - name: Wait for container initialization
      ansible.builtin.pause:
        seconds: 10

# ==============================================================================
# STEP 2: Health check - wait for vLLM to be ready
# ==============================================================================

- name: "Wait for vLLM to be ready ({{ hostvars['localhost']['current_core_count'] }} cores)"
  hosts: load_generator
  gather_facts: false

  tasks:
    - name: Wait for vLLM health endpoint
      ansible.builtin.uri:
        url: "http://{{ bench_config.vllm_host }}:{{ bench_config.vllm_port }}/health"
        method: GET
        status_code: 200
      register: health_check
      retries: 60
      delay: 5
      until: health_check.status == 200

    - name: Display readiness status
      ansible.builtin.debug:
        msg: "vLLM is ready with {{ hostvars['localhost']['current_core_count'] }} cores"

# ==============================================================================
# STEP 3: Run embedding tests
# ==============================================================================

- name: "Run embedding test with {{ hostvars['localhost']['current_core_count'] }} cores"
  hosts: load_generator
  become: true
  vars:
    cores_config: "{{ hostvars['localhost']['current_core_count'] }}"
    model: "{{ hostvars['localhost']['model_name'] }}"
    scenario: "{{ hostvars['localhost']['test_scenario'] }}"

  tasks:
    - name: Create results directory for this core count
      ansible.builtin.file:
        path: "{{ bench_config.results_dir }}/core-sweep/{{ cores_config }}cores/{{ model | basename }}/{{ scenario }}"
        state: directory
        mode: "0755"
        recurse: true

    - name: Run test scenario
      ansible.builtin.include_tasks:
        file: "{{ scenario }}.yml"

    - name: Tag results with core count metadata
      ansible.builtin.copy:
        content: |
          {
            "test_run_id": "{{ hostvars['localhost']['test_run_id'] }}",
            "core_count": {{ cores_config }},
            "cpu_set": "0-{{ cores_config - 1 }}",
            "model": "{{ model }}",
            "scenario": "{{ scenario }}",
            "timestamp": "{{ ansible_date_time.iso8601 }}"
          }
        dest: "{{ bench_config.results_dir }}/core-sweep/{{ cores_config }}cores/test-metadata.json"

# ==============================================================================
# STEP 4: Collect logs for this iteration
# ==============================================================================

- name: "Collect vLLM logs for {{ hostvars['localhost']['current_core_count'] }} cores"
  hosts: dut
  become: true
  vars:
    cores_config: "{{ hostvars['localhost']['current_core_count'] }}"

  tasks:
    - name: Get vLLM container logs
      ansible.builtin.command:
        cmd: "podman logs vllm-embedding-server"
      register: vllm_logs
      changed_when: false

    - name: Save vLLM logs
      ansible.builtin.copy:
        content: "{{ vllm_logs.stdout }}"
        dest: "{{ log_dir }}/vllm-{{ cores_config }}cores-{{ hostvars['localhost']['test_run_id'] }}.log"

# ==============================================================================
# STEP 5: Stop vLLM container before next iteration
# ==============================================================================

- name: "Stop vLLM container ({{ hostvars['localhost']['current_core_count'] }} cores)"
  hosts: dut
  become: true

  tasks:
    - name: Stop and remove vLLM container
      containers.podman.podman_container:
        name: vllm-embedding-server
        state: absent

    - name: Wait before next iteration
      ansible.builtin.pause:
        seconds: 5
      when: hostvars['localhost']['current_core_count'] != hostvars['localhost']['core_counts'][-1]
