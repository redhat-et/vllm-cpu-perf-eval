---
# Latency and concurrent load test tasks
# Included by run-embedding-tests.yml

- name: Define concurrency levels to test
  ansible.builtin.set_fact:
    concurrency_levels: [16, 32, 64, 128, 196]

- name: "Latency Test - Run at each concurrency level"
  ansible.builtin.command:
    cmd: >
      vllm bench serve
      --host {{ bench_config.vllm_host }}
      --port {{ bench_config.vllm_port }}
      --backend openai-embeddings
      --model {{ model_name }}
      --dataset-name random
      --random-input-len 512
      --num-prompts 1000
      --endpoint /v1/embeddings
      --request-rate inf
      --max-concurrency {{ item }}
      --save-result
      --result-filename {{ bench_config.results_dir }}/{{ model_name | basename }}/latency/concurrent-{{ item }}.json
  loop: "{{ concurrency_levels }}"
  register: latency_tests
  changed_when: true

- name: Display latency test results summary
  ansible.builtin.debug:
    msg:
      - "Latency tests completed for concurrency levels: {{ concurrency_levels }}"
      - "Results saved to {{ bench_config.results_dir }}/{{ model_name | basename }}/latency/"
      - "Look for P99 latency sweet spot and degradation point"
