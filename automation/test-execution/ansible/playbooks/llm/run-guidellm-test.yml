---
# Run Single GuideLLM Test for LLM Generative Models
# Tests one model with one core configuration and one workload

- name: "LLM GuideLLM Test - Setup"
  hosts: localhost
  gather_facts: false
  vars:
    test_run_id: "{{ lookup('pipe', 'date +%Y%m%d-%H%M%S') }}"

  tasks:
    - name: Validate required variables
      ansible.builtin.assert:
        that:
          - test_model is defined
          - workload_type is defined
          - core_config_name is defined
        fail_msg: |
          Missing required variables. Please provide:
          -e "test_model=<model>"
          -e "workload_type=<summarization|chat|code|rag>"
          -e "core_config_name=<config_name>"

    - name: Get core configuration by name
      ansible.builtin.set_fact:
        core_configuration: "{{ core_configs | selectattr('name', 'equalto', core_config_name) | first }}"
      failed_when: core_configuration is not defined

    - name: Display test information
      ansible.builtin.debug:
        msg:
          - "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          - "LLM GuideLLM Performance Test"
          - "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          - "Test Run ID: {{ test_run_id }}"
          - "Model: {{ test_model }}"
          - "Workload: {{ workload_type }}"
          - "Load Generator: {{ groups['load_generator'][0] }} ({{ hostvars[groups['load_generator'][0]]['ansible_host'] }})"
          - "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

    - name: Set vLLM mode
      ansible.builtin.set_fact:
        vllm_mode: "{{ vllm_endpoint.mode | default('managed') }}"

    - name: Display vLLM configuration (Managed Mode)
      ansible.builtin.debug:
        msg:
          - "vLLM Mode: managed"
          - "DUT Host: {{ groups['dut'][0] }} ({{ hostvars[groups['dut'][0]]['ansible_host'] }})"
          - "Core Config: {{ core_config_name }} ({{ core_configuration.cores }} cores, TP={{ core_configuration.tensor_parallel }})"
      when: vllm_mode == 'managed'

    - name: Display vLLM configuration (External Mode)
      ansible.builtin.debug:
        msg:
          - "vLLM Mode: external"
          - "External Endpoint: {{ vllm_endpoint.external.url }}"
          - "Note: Core config only affects load generator CPU allocation, not the external vLLM server"
      when: vllm_mode == 'external'

# ==============================================================================
# PHASE 1: Start vLLM Server on DUT (Managed Mode Only)
# ==============================================================================

- name: "Phase 1 - Start vLLM Server on DUT"
  hosts: dut
  become: true
  gather_facts: false
  vars:
    core_configuration: "{{ hostvars['localhost']['core_configuration'] }}"

  tasks:
    - name: Start vLLM for LLM model
      ansible.builtin.include_tasks:
        file: tasks/start-llm-vllm.yml
      when: hostvars['localhost']['vllm_mode'] == 'managed'

# ==============================================================================
# PHASE 1-External: Configure External Endpoint (External Mode Only)
# ==============================================================================

- name: "Phase 1-External - Configure External Endpoint"
  hosts: load_generator
  gather_facts: false

  tasks:
    - block:
        - name: Validate external endpoint URL
          ansible.builtin.assert:
            that:
              - vllm_endpoint.external.url is defined
              - vllm_endpoint.external.url is not none
              - vllm_endpoint.external.url | length > 0
            fail_msg: "External endpoint URL is required when mode=external"

        - name: Parse external endpoint URL
          ansible.builtin.set_fact:
            external_endpoint_parsed: "{{ vllm_endpoint.external.url | urlsplit }}"

        - name: Override bench_config for external endpoint
          ansible.builtin.set_fact:
            bench_config: "{{ bench_config | combine({'vllm_host': external_endpoint_parsed.hostname, 'vllm_port': external_endpoint_parsed.port | default(8000) | int}) }}"

        - name: Setup API key if enabled
          ansible.builtin.include_tasks:
            file: ../common/tasks/setup-vllm-api-key.yml
          when: vllm_endpoint.external.api_key.enabled | default(false) | bool

        - name: Display external endpoint configuration
          ansible.builtin.debug:
            msg:
              - "External vLLM Endpoint: {{ vllm_endpoint.external.url }}"
              - "Parsed Host: {{ bench_config.vllm_host }}"
              - "Parsed Port: {{ bench_config.vllm_port }}"
              - "{{ 'API Key: Enabled' if vllm_api_key is defined else 'API Key: Not configured' }}"
      when: hostvars['localhost']['vllm_mode'] == 'external'

# ==============================================================================
# PHASE 2: Health Check - Wait for vLLM
# ==============================================================================

- name: "Phase 2 - Wait for vLLM Server to be Ready"
  ansible.builtin.import_playbook: ../common/health-check.yml

# ==============================================================================
# PHASE 3: Run GuideLLM Benchmark
# ==============================================================================

- name: "Phase 3 - Run GuideLLM Benchmark"
  hosts: load_generator
  become: "{{ ansible_connection != 'local' }}"
  vars:
    core_configuration: "{{ hostvars['localhost']['core_configuration'] }}"

  tasks:
    - name: Setup HuggingFace token for load generator
      ansible.builtin.include_tasks:
        file: ../common/tasks/setup-hf-token.yml

    - name: Run GuideLLM benchmark
      ansible.builtin.include_tasks:
        file: tasks/run-guidellm.yml

# ==============================================================================
# PHASE 4: Collect Results and Logs
# ==============================================================================

- name: "Phase 4 - Collect Benchmark Results"
  ansible.builtin.import_playbook: ../common/collect-benchmark-results.yml

- name: "Phase 4 - Collect DUT Logs"
  ansible.builtin.import_playbook: ../common/collect-dut-logs.yml

# ==============================================================================
# PHASE 5: Cleanup (Optional, Managed Mode Only)
# ==============================================================================

- name: "Phase 5 - Cleanup (if requested)"
  hosts: dut
  become: true
  gather_facts: false
  vars:
    cleanup: "{{ cleanup_after_test | default(false) }}"

  tasks:
    - block:
        - name: Stop vLLM container
          containers.podman.podman_container:
            name: "{{ vllm_container_name }}"
            state: stopped
          when:
            - cleanup | bool
            - vllm_server.container_runtime == 'podman'

        - name: Display cleanup status
          ansible.builtin.debug:
            msg: "vLLM server {{ 'stopped' if cleanup else 'still running - use cleanup_after_test=true to stop' }}"
      when: hostvars['localhost']['vllm_mode'] | default('managed') == 'managed'

# ==============================================================================
# SUMMARY
# ==============================================================================

- name: "Test Summary"
  hosts: localhost
  gather_facts: false

  tasks:
    - name: Display test summary
      ansible.builtin.debug:
        msg:
          - "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          - "✓ LLM GuideLLM Test Complete!"
          - "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          - "Model: {{ test_model }}"
          - "Workload: {{ workload_type }}"
          - "Core Config: {{ core_config_name }}"
          - "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          - "Results: results/{{ test_model | basename }}/{{ workload_type }}/{{ core_config_name }}/"
          - "Logs: results/logs/"
          - "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
