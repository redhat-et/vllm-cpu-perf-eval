---
# Core Count Sweep for LLM Generative Models
# Tests one model across multiple core configurations (e.g., T14, T16, T17, T18)
# Each iteration: clean restart → start vLLM → health check → run GuideLLM → collect results

- name: "LLM Core Sweep - Setup"
  hosts: localhost
  gather_facts: false
  vars:
    test_run_id: "{{ lookup('pipe', 'date +%Y%m%d-%H%M%S') }}"

  tasks:
    - name: Validate required variables
      ansible.builtin.assert:
        that:
          - test_model is defined
          - workload_type is defined
          - core_config_names is defined
        fail_msg: |
          Missing required variables. Please provide:
          -e "test_model=<model>"
          -e "workload_type=<summarization|chat|code|rag>"
          -e "core_config_names=['config1','config2',...]"

    - name: Get core configurations by names
      ansible.builtin.set_fact:
        selected_core_configs: "{{ core_configs | selectattr('name', 'in', core_config_names) | list }}"

    - name: Validate core configurations found
      ansible.builtin.assert:
        that:
          - selected_core_configs | length > 0
          - selected_core_configs | length == core_config_names | length
        fail_msg: "Could not find all specified core configurations. Check core_config_names."

    - name: Display core sweep test information
      ansible.builtin.debug:
        msg:
          - "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          - "LLM Core Count Sweep Test"
          - "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          - "Test Run ID: {{ test_run_id }}"
          - "Model: {{ test_model }}"
          - "Workload: {{ workload_type }}"
          - "Core Configurations: {{ core_config_names }}"
          - "DUT: {{ groups['dut'][0] }}"
          - "Load Generator: {{ groups['load_generator'][0] }}"
          - "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

    - name: Set vLLM mode
      ansible.builtin.set_fact:
        vllm_mode: "{{ vllm_endpoint.mode | default('managed') }}"

    - name: Display vLLM configuration
      ansible.builtin.debug:
        msg:
          - "vLLM Mode: {{ vllm_mode }}"
          - "{{ 'External Endpoint: ' + vllm_endpoint.external.url if vllm_mode == 'external' else 'Managed on DUT: ' + groups['dut'][0] }}"

    - name: Warn about external mode with core sweep
      ansible.builtin.debug:
        msg:
          - "⚠️  WARNING: External mode does not support core configuration."
          - "All tests will run against the same external endpoint regardless of core_config_names."
      when: vllm_mode == 'external'

# ==============================================================================
# EXTERNAL MODE: Configure External Endpoint (Once)
# ==============================================================================

- name: "Configure External Endpoint"
  hosts: load_generator
  gather_facts: false

  tasks:
    - block:
        - name: Validate external endpoint URL
          ansible.builtin.assert:
            that:
              - vllm_endpoint.external.url is defined
              - vllm_endpoint.external.url is not none
              - vllm_endpoint.external.url | length > 0
            fail_msg: "External endpoint URL is required when mode=external"

        - name: Parse external endpoint URL
          ansible.builtin.set_fact:
            external_endpoint_parsed: "{{ vllm_endpoint.external.url | urlsplit }}"

        - name: Override bench_config for external endpoint
          ansible.builtin.set_fact:
            bench_config: "{{ bench_config | combine({'vllm_host': external_endpoint_parsed.hostname, 'vllm_port': external_endpoint_parsed.port | default(8000) | int}) }}"

        - name: Setup API key if enabled
          ansible.builtin.include_tasks:
            file: ../common/tasks/setup-vllm-api-key.yml
          when: vllm_endpoint.external.api_key.enabled | default(false) | bool

        - name: Display external endpoint configuration
          ansible.builtin.debug:
            msg:
              - "External vLLM Endpoint: {{ vllm_endpoint.external.url }}"
              - "Parsed Host: {{ bench_config.vllm_host }}"
              - "Parsed Port: {{ bench_config.vllm_port }}"
              - "{{ 'API Key: Enabled' if vllm_api_key is defined else 'API Key: Not configured' }}"

      when: hostvars['localhost']['vllm_mode'] == 'external'
- name: "Health Check - External Endpoint"
  ansible.builtin.import_playbook: ../common/health-check.yml

# ==============================================================================
# MAIN LOOP: Iterate over core configurations
# ==============================================================================

- name: "Core Sweep - Run Tests for Each Core Configuration"
  hosts: localhost
  gather_facts: false

  tasks:
    - block:
        - name: Run test sequence for each core configuration
          ansible.builtin.include_tasks:
            file: tasks/core-sweep-iteration.yml
          loop: "{{ selected_core_configs }}"
          loop_control:
            loop_var: current_core_config
            label: "{{ current_core_config.name }} ({{ current_core_config.cores }} cores, TP={{ current_core_config.tensor_parallel }})"

      when: hostvars['localhost']['vllm_mode'] == 'external'
# ==============================================================================
# FINAL: Collect All Results
# ==============================================================================

- name: "Core Sweep - Collect and Summarize All Results"
  hosts: load_generator
  gather_facts: false
  vars:
    test_run_id: "{{ hostvars['localhost']['test_run_id'] }}"

  tasks:
    - name: Fetch all core sweep results
      ansible.builtin.fetch:
        src: "{{ bench_config.results_dir }}/{{ test_model | basename }}/{{ workload_type }}/"
        dest: "{{ playbook_dir }}/../../../results/llm/{{ test_model | basename }}/{{ workload_type }}-{{ test_run_id }}/"
        flat: false

    - name: Display results location
      ansible.builtin.debug:
        msg:
          - "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          - "✓ Core sweep tests completed!"
          - "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          - "Results: results/llm/{{ test_model | basename }}/{{ workload_type }}-{{ test_run_id }}/"
          - "Analyze results to find optimal core configuration"
          - "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

# ==============================================================================
# SUMMARY
# ==============================================================================

- name: "Core Sweep Summary"
  hosts: localhost
  gather_facts: false

  tasks:
    - name: Display test configurations summary
      ansible.builtin.debug:
        msg:
          - "Core Configurations Tested:"
          - "{{ selected_core_configs | map(attribute='name') | list }}"
          - ""
          - "Configuration Details:"

    - name: Display each core configuration
      ansible.builtin.debug:
        msg:
          - "{{ item.name }}:"
          - "  Cores: {{ item.cores }}"
          - "  CPUs: {{ item.cpuset_cpus }}"
          - "  NUMA: {{ item.cpuset_mems }}"
          - "  TP: {{ item.tensor_parallel }}"
          - "  OMP Threads: {{ item.omp_num_threads | default('auto') }}"
          - "  OMP Bind: {{ item.omp_threads_bind | default('auto') }}"
      loop: "{{ selected_core_configs }}"
      loop_control:
        label: "{{ item.name }}"
