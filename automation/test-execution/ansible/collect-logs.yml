---
# Common Log Collection Playbook
# Collects logs from DUT and load generator
# Can be imported by other playbooks or run standalone

- name: "Collect Logs - Setup"
  hosts: localhost
  gather_facts: false
  vars:
    collection_id: "{{ lookup('pipe', 'date +%Y%m%d-%H%M%S') }}"

  tasks:
    - name: Set collection_id fact for all hosts
      ansible.builtin.set_fact:
        collection_id: "{{ collection_id }}"
      delegate_to: "{{ item }}"
      delegate_facts: true
      loop: "{{ groups['all'] }}"

    - name: Display log collection info
      ansible.builtin.debug:
        msg:
          - "Log Collection ID: {{ collection_id }}"
          - "DUT: {{ groups['dut'][0] }}"
          - "Load Generator: {{ groups['load_generator'][0] }}"

# ==============================================================================
# Collect Logs and Results Using Role
# ==============================================================================

- name: "Collect vLLM Server Logs from DUT"
  hosts: dut
  become: true

  roles:
    - role: results_collector

- name: "Collect Test Results from Load Generator"
  hosts: load_generator
  become: true

  roles:
    - role: results_collector

# ==============================================================================
# Summary
# ==============================================================================

- name: "Log Collection Summary"
  hosts: localhost
  gather_facts: false

  tasks:
    - name: Display collection summary
      ansible.builtin.debug:
        msg:
          - "Log Collection Complete!"
          - "Collection ID: {{ collection_id }}"
          - "Logs saved to: {{ playbook_dir }}/../../../results/logs/"
          - "Results saved to: {{ playbook_dir }}/../../../results/benchmark-results/"
          - ""
          - "View logs:"
          - "  DUT logs: cat results/logs/{{ groups['dut'][0] }}/*.log"
          - "  Results: ls -lh results/benchmark-results/"
