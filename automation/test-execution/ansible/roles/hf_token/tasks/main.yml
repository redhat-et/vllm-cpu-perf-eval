---
# Setup HuggingFace Token
# Supports multiple token sources: environment variable, file, Ansible vault, prompt
# Sets hf_token fact for use in other tasks

- name: Get HuggingFace token from environment variable
  ansible.builtin.set_fact:
    hf_token: "{{ lookup('env', huggingface.token_env_var) }}"
  when:
    - huggingface.token_source == 'env'
    - hf_token is not defined
  no_log: true

- name: Get HuggingFace token from file
  ansible.builtin.slurp:
    src: "{{ huggingface.token_file }}"
  register: hf_token_file_content
  when:
    - huggingface.token_source == 'file'
    - hf_token is not defined
    - huggingface.token_file is defined
  no_log: true

- name: Set HuggingFace token from file content
  ansible.builtin.set_fact:
    hf_token: "{{ hf_token_file_content.content | b64decode | trim }}"
  when:
    - huggingface.token_source == 'file'
    - hf_token_file_content is defined
  no_log: true

- name: Get HuggingFace token from Ansible vault
  ansible.builtin.set_fact:
    hf_token: "{{ huggingface.token_vault }}"
  when:
    - huggingface.token_source == 'vault'
    - hf_token is not defined
    - huggingface.token_vault is defined
  no_log: true

- name: Prompt for HuggingFace token
  ansible.builtin.pause:
    prompt: "Enter your HuggingFace token"
    echo: false
  register: hf_token_prompt
  when:
    - huggingface.token_source == 'prompt'
    - hf_token is not defined
  no_log: true

- name: Set HuggingFace token from prompt
  ansible.builtin.set_fact:
    hf_token: "{{ hf_token_prompt.user_input }}"
  when:
    - huggingface.token_source == 'prompt'
    - hf_token_prompt is defined
  no_log: true

- name: Validate HuggingFace token is set
  ansible.builtin.assert:
    that:
      - hf_token is defined
      - hf_token | length > 0
    fail_msg: |
      HuggingFace token is not set. Configure one of:
      1. Environment variable: export {{ huggingface.token_env_var }}=<token>
      2. File: Set huggingface.token_file in inventory
      3. Vault: Set huggingface.token_vault in inventory
      4. Prompt: Set huggingface.token_source=prompt in inventory
    success_msg: "âœ“ HuggingFace token configured"
  no_log: true

- name: Display token source (masked)
  ansible.builtin.debug:
    msg: "HuggingFace token loaded from: {{ huggingface.token_source }} (hf_***{{ hf_token[-4:] }})"
  when: hf_token is defined
